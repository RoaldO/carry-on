name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Run linter
        run: uv run nox -s lint

      - name: Check formatting
        run: uv run nox -s format_check

      - name: Type check
        run: uv run nox -s typecheck

      - name: Architecture check
        run: uv run nox -s arch

      - name: Security scan
        run: uv run nox -s security

  test:
    needs: lint
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Install Playwright browsers
        run: uv run playwright install chromium --with-deps

      - name: Run tests with coverage and Allure
        run: uv run pytest -v --cov-report=xml --cov-report=html --alluredir=allure-results
        env:
          MONGODB_URI: "mongodb://admin:password@localhost:27017"

      - name: Upload coverage XML
        uses: actions/upload-artifact@v6
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-html
          path: htmlcov/

      - name: Upload Allure results
        uses: actions/upload-artifact@v6
        with:
          name: allure-results
          path: allure-results/

      - name: Restore Allure history cache
        uses: actions/cache/restore@v4
        with:
          path: allure-history
          key: allure-history-${{ github.ref_name }}
          restore-keys: |
            allure-history-main
            allure-history-

      - name: Copy history to allure-results
        run: |
          if [ -d allure-history/history ]; then
            sudo cp -r allure-history/history allure-results/
            sudo chown -R $USER:$USER allure-results/history
          fi

      - name: Copy Allure categories
        run: cp allure-categories.json allure-results/categories.json

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report

      - name: Save Allure history for next run
        run: |
          sudo rm -rf allure-history
          mkdir -p allure-history
          if [ -d allure-report/history ]; then
            cp -r allure-report/history allure-history/
          fi

      - name: Save Allure history cache
        uses: actions/cache/save@v4
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        with:
          path: allure-history
          key: allure-history-${{ github.ref_name }}-${{ github.run_id }}

      - name: Prepare GitHub Pages content
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          rm -rf gh-pages
          mkdir -p gh-pages
          cp -r htmlcov gh-pages/coverage
          cp -r allure-report gh-pages/allure
          if [ -f warnings.txt ]; then
            cp warnings.txt gh-pages/warnings.txt
            WARNINGS_LINK='<a href="warnings.txt">Test Warnings</a>'
          else
            WARNINGS_LINK='<span style="color:#999;padding:15px;display:block;">No warnings</span>'
          fi
          cat > gh-pages/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>CarryOn Reports</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
              h1 { color: #2d5a27; }
              a { display: block; padding: 15px; margin: 10px 0; background: #f5f5f5; border-radius: 8px; text-decoration: none; color: #333; }
              a:hover { background: #e8f5e6; }
            </style>
          </head>
          <body>
            <h1>CarryOn Reports</h1>
            <a href="coverage/">Coverage Report</a>
            <a href="allure/">Test Results (Allure)</a>
            $WARNINGS_LINK
          </body>
          </html>
          EOF

      - name: Upload pages artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-pages-artifact@v4
        with:
          path: gh-pages/

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
